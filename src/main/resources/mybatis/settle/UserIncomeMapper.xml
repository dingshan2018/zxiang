<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zxiang.project.settle.userIncome.mapper.UserIncomeMapper">
    
    <resultMap type="UserIncome" id="UserIncomeResult">
      <id column="income_id" property="incomeId" jdbcType="INTEGER" />
    <result column="coperator_id" property="coperatorId" jdbcType="INTEGER" />
    <result column="coperator_type" property="coperatorType" jdbcType="VARCHAR" />
    <result column="sum_date" property="sumDate" jdbcType="TIMESTAMP" />
    <result column="ad_income" property="adIncome" jdbcType="DOUBLE" />
    <result column="ad_carousel_income" property="adCarouselIncome" jdbcType="DOUBLE" />
    <result column="scan_income" property="scanIncome" jdbcType="DOUBLE" />
    <result column="prom_direct_income" property="promDirectIncome" jdbcType="INTEGER" />
    <result column="prom_indirect_income" property="promIndirectIncome" jdbcType="INTEGER" />
    <result column="promotion_income" property="promotionIncome" jdbcType="DOUBLE" />
    <result column="paper_income" property="paperIncome" jdbcType="INTEGER" />
    <result column="direct_agent_income" property="directAgentIncome" jdbcType="DOUBLE" />
    <result column="subsidy_income" property="subsidyIncome" jdbcType="DOUBLE" />
    <result column="ad_income_rate" property="adIncomeRate" jdbcType="DOUBLE" />
    <result column="promotion_income_rate" property="promotionIncomeRate" jdbcType="DOUBLE" />
    <result column="scan_income_rate" property="scanIncomeRate" jdbcType="DOUBLE" />
    <result column="ad_rate" property="adRate" jdbcType="REAL" />
    <result column="ad_carousel_rate" property="adCarouselRate" jdbcType="REAL" />
    <result column="scan_rate" property="scanRate" jdbcType="REAL" />
    <result column="prom_direct_rate" property="promDirectRate" jdbcType="REAL" />
    <result column="prom_indirect_rate" property="promIndirectRate" jdbcType="REAL" />
    <result column="prom_paper_rate" property="promPaperRate" jdbcType="REAL" />
    <result column="promotion_rate" property="promotionRate" jdbcType="REAL" />
    <result column="direct_agent_rate" property="directAgentRate" jdbcType="REAL" />
    <result column="serve_rate" property="serveRate" jdbcType="REAL" />
    <result column="subsidy_rate" property="subsidyRate" jdbcType="REAL" />
    <result column="refund_income" property="refundIncome" jdbcType="DOUBLE" />
    <result column="refund_income_rate" property="refundIncomeRate" jdbcType="DOUBLE" />
    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_by" property="updateBy" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    </resultMap>
	
	<sql id="selectUserIncomeVo">
	select income_id, coperator_id, coperator_type, sum_date, ad_income, ad_carousel_income, 
    scan_income, prom_direct_income, prom_indirect_income, paper_income, prom_paper_income, 
    direct_agent_income, subsidy_income, ad_income_rate, promotion_income_rate, scan_income_rate, 
    subsidy_income_rate, ad_rate, ad_carousel_rate, scan_rate, prom_direct_rate, prom_indirect_rate, 
    prom_paper_rate, promotion_rate, direct_agent_rate, serve_rate, subsidy_rate, refund_income, 
    refund_income_rate, create_by, create_time, update_by, update_time from zx_user_income
    </sql>
	
    <select id="selectUserIncomeList" parameterType="UserIncome" resultMap="UserIncomeResult">
        <include refid="selectUserIncomeVo"/>
        <where>  
            <if test="incomeId != null and incomeId != ''"> and income_id = #{incomeId}</if>
             <if test="coperatorId != null and coperatorId != ''"> and coperator_id = #{coperatorId}</if>
             <if test="coperatorType != null and coperatorType != ''"> and coperator_type = #{coperatorType}</if>
              <if test="params.beginTime != null and params.beginTime != ''"><!-- 开始时间检索 -->
				AND date_format(sum_date,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
			 </if>
			 <if test="params.endTime != null and params.endTime != ''"><!-- 结束时间检索 -->
				AND date_format(sum_date,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
			 </if>
         </where>
    </select>
    
    <select id="selectUserIncomeById" parameterType="Integer" resultMap="UserIncomeResult">
        <include refid="selectUserIncomeVo"/>
        where income_id = #{incomeId}
    </select>
        
    <insert id="insertUserIncome" parameterType="UserIncome">
        insert into zx_user_income
          <trim prefix="(" suffix=")" suffixOverrides="," >
	      <if test="coperatorId != null" >
	        coperator_id,
	      </if>
	      <if test="coperatorType != null" >
	        coperator_type,
	      </if>
	
	      <if test="adIncome != null" >
	        ad_income,
	      </if>
	      <if test="adCarouselIncome != null" >
	        ad_carousel_income,
	      </if>
	      <if test="scanIncome != null" >
	        scan_income,
	      </if>
	      <if test="promDirectIncome != null" >
	        prom_direct_income,
	      </if>
	      <if test="promIndirectIncome != null" >
	        prom_indirect_income,
	      </if>
	      <if test="promotionIncome != null" >
	        promotion_income,
	      </if>
	      <if test="paperIncome != null" >
	        paper_income,
	      </if>
	      <if test="promPaperIncome != null" >
	        prom_paper_income,
	      </if>
	      <if test="directAgentIncome != null" >
	        direct_agent_income,
	      </if>
	      <if test="subsidyIncome != null" >
	        subsidy_income,
	      </if>
	      <if test="adIncomeRate != null" >
	        ad_income_rate,
	      </if>
	      <if test="promotionIncomeRate != null" >
	        promotion_income_rate,
	      </if>
	      <if test="scanIncomeRate != null" >
	        scan_income_rate,
	      </if>
	      <if test="subsidyIncomeRate != null" >
	        subsidy_income_rate,
	      </if>
	      <if test="adRate != null" >
	        ad_rate,
	      </if>
	      <if test="adCarouselRate != null" >
	        ad_carousel_rate,
	      </if>
	      <if test="scanRate != null" >
	        scan_rate,
	      </if>
	      <if test="promDirectRate != null" >
	        prom_direct_rate,
	      </if>
	      <if test="promIndirectRate != null" >
	        prom_indirect_rate,
	      </if>
	      <if test="promPaperRate != null" >
	        prom_paper_rate,
	      </if>
	      <if test="promotionRate != null" >
	        promotion_rate,
	      </if>
	      <if test="directAgentRate != null" >
	        direct_agent_rate,
	      </if>
	      <if test="serveRate != null" >
	        serve_rate,
	      </if>
	      <if test="subsidyRate != null" >
	        subsidy_rate,
	      </if>
	      <if test="refundIncome != null" >
	        refund_income,
	      </if>
	      <if test="refundIncomeRate != null" >
	        refund_income_rate,
	      </if>
	         sum_date,
		     create_time
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	      <if test="coperatorId != null" >
	        #{coperatorId,jdbcType=INTEGER},
	      </if>
	      <if test="coperatorType != null" >
	        #{coperatorType,jdbcType=VARCHAR},
	      </if>
	      <if test="adIncome != null" >
	        #{adIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="adCarouselIncome != null" >
	        #{adCarouselIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="scanIncome != null" >
	        #{scanIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="promDirectIncome != null" >
	        #{promDirectIncome,jdbcType=INTEGER},
	      </if>
	      <if test="promIndirectIncome != null" >
	        #{promIndirectIncome,jdbcType=INTEGER},
	      </if>
	      <if test="promotionIncome != null" >
	        #{promotionIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="paperIncome != null" >
	        #{paperIncome,jdbcType=INTEGER},
	      </if>
	     <if test="promPaperIncome != null" >
	        #{promPaperIncome,jdbcType=INTEGER},
	      </if>
	      <if test="directAgentIncome != null" >
	        #{directAgentIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="subsidyIncome != null" >
	        #{subsidyIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="adIncomeRate != null" >
	        #{adIncomeRate,jdbcType=DOUBLE},
	      </if>
	      <if test="promotionIncomeRate != null" >
	        #{promotionIncomeRate,jdbcType=DOUBLE},
	      </if>
	      <if test="scanIncomeRate != null" >
	        #{scanIncomeRate,jdbcType=DOUBLE},
	      </if>
	      <if test="subsidyIncomeRate != null" >
	        #{subsidyIncomeRate,jdbcType=DOUBLE},
	      </if>
	      <if test="adRate != null" >
	        #{adRate,jdbcType=REAL},
	      </if>
	      <if test="adCarouselRate != null" >
	        #{adCarouselRate,jdbcType=REAL},
	      </if>
	      <if test="scanRate != null" >
	        #{scanRate,jdbcType=REAL},
	      </if>
	      <if test="promDirectRate != null" >
	        #{promDirectRate,jdbcType=REAL},
	      </if>
	      <if test="promIndirectRate != null" >
	        #{promIndirectRate,jdbcType=REAL},
	      </if>
	      <if test="promPaperRate != null" >
	        #{promPaperRate,jdbcType=REAL},
	      </if>
	      <if test="promotionRate != null" >
	        #{promotionRate,jdbcType=REAL},
	      </if>
	      <if test="directAgentRate != null" >
	        #{directAgentRate,jdbcType=REAL},
	      </if>
	      <if test="serveRate != null" >
	        #{serveRate,jdbcType=REAL},
	      </if>
	      <if test="subsidyRate != null" >
	        #{subsidyRate,jdbcType=REAL},
	      </if>
	      <if test="refundIncome != null" >
	        #{refundIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="refundIncomeRate != null" >
	        #{refundIncomeRate,jdbcType=DOUBLE},
	      </if>
	          DATE_SUB(CURDATE(), INTERVAL 1 DAY),
			DATE_SUB(CURDATE(), INTERVAL 1 DAY)
	    </trim>

    </insert>
	 
    <update id="updateUserIncome" parameterType="UserIncome">
        update zx_user_income
        <trim prefix="SET" suffixOverrides=",">
	      <if test="adIncome != null" >
	        ad_income = ad_income+#{adIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="adCarouselIncome != null" >
	        ad_carousel_income =ad_carousel_income+ #{adCarouselIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="scanIncome != null" >
	        scan_income =scan_income+ #{scanIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="promDirectIncome != null" >
	        prom_direct_income = prom_direct_income + #{promDirectIncome,jdbcType=INTEGER},
	      </if>
	      <if test="promIndirectIncome != null" >
	        prom_indirect_income =prom_indirect_income+ #{promIndirectIncome,jdbcType=INTEGER},
	      </if>
	      <if test="promotionIncome != null" >
	        promotion_income =promotion_income+ #{promotionIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="paperIncome != null" >
	        paper_income = paper_income+#{paperIncome,jdbcType=INTEGER},
	      </if>
	      <if test="promPaperIncome != null" >
	        prom_paper_income = prom_paper_income+ #{promPaperIncome,jdbcType=INTEGER},
	      </if>
	      <if test="directAgentIncome != null" >
	        direct_agent_income =direct_agent_income+ #{directAgentIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="subsidyIncome != null" >
	        subsidy_income =subsidy_income + #{subsidyIncome,jdbcType=DOUBLE},
	      </if>
	       <if test="adIncomeRate != null  ">ad_income_rate =ad_income_rate+ #{adIncomeRate},</if>
	       <if test="promotionIncomeRate != null  ">promotion_income_rate =promotion_income_rate+ #{promotionIncomeRate},</if>
	       <if test="scanIncomeRate != null  ">scan_income_rate =scan_income_rate+#{scanIncomeRate},</if>
	       <if test="subsidyIncomeRate != null" >
	          subsidy_income_rate = subsidy_income_rate+#{subsidyIncomeRate,jdbcType=DOUBLE},
	      </if>
	       <if test="refundIncome != null" >
	        refund_income = refund_income+#{refundIncome,jdbcType=DOUBLE},
	      </if>
	      <if test="refundIncomeRate != null" >
	        refund_income_rate = refund_income_rate+#{refundIncomeRate,jdbcType=DOUBLE},
	      </if>
        </trim>
        where income_id = #{incomeId}
    </update>

	<delete id="deleteUserIncomeById" parameterType="Integer">
        delete from zx_user_income where income_id = #{incomeId}
    </delete>
	
    <delete id="deleteUserIncomeByIds" parameterType="String">
        delete from zx_user_income where income_id in 
        <foreach item="incomeId" collection="array" open="(" separator="," close=")">
            #{incomeId}
        </foreach>
    </delete>
    
    
    <select id="selectUserIncome" parameterType="UserIncome" resultMap="UserIncomeResult">
        select income_id from zx_user_income
        <where>  
             <if test="coperatorId != null and coperatorId != ''"> and coperator_id = #{coperatorId}</if>
             and DATE_FORMAT(sum_date, '%Y-%m-%d') = DATE_FORMAT(
			    DATE_SUB(CURDATE(), INTERVAL 1 DAY),
			    '%Y-%m-%d'
			  )
         </where>
    </select>
    <!-- 用户角色信息数据 -->
    
      <!-- 判断销售人类型 -->
      <select id="selectzxsellerlist" parameterType="string"  resultType="java.util.HashMap">
		  SELECT  * FROM  sys_user WHERE user_id = #{sellerId}
    </select>
    
     <!-- 判断销售人类型 -->
      <select id="selectuserbypuserId" parameterType="string"  resultType="java.util.HashMap">
		  SELECT  * FROM  sys_user WHERE puser_id = #{puserId}
    </select>
    
    
    <!-- 代理商 -->
     <select id="selectzxagentlist"  resultType="java.util.HashMap">
		 SELECT 
		  t.user_id,
		  t.leader_id,
		  z.city,
		  z.county,
		  z.level,
		  z.promotor_id,
		  z.agency_fee,
		  z.create_time 
		FROM
		  sys_user t,
		  zx_agent z 
		  WHERE 
		  t.puser_id = z.agent_id
		  AND t.del_flag = '0'
		  and z.del_flag = '0'
		  <if test="userId != null and userId != ''">
		    AND t.user_id = #{userId}
		  </if>
		  <if test="placeId != null and placeId != ''">
		     AND ((z.level = 1 AND z.city = #{placeId} ) OR (z.level = 2 AND z.county = #{placeId} ))
		  </if>
		  <if test="promotionagent != null and promotionagent != ''">
		     AND DATE_FORMAT(z.create_time, '%Y-%m-%d') = DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 DAY),'%Y-%m-%d')
		  </if>
    </select>
    
    
        <!-- 代理商 -->
     <select id="selectzxagent"  resultType="java.util.HashMap">
		 SELECT 
		 ad_rate adRate,
		 ad_carousel_rate adCarouselRate,
		 scan_rate  scanRate,
		 prom_direct_rate promDirectRate,
		 prom_indirect_rate  promIndirectRate,
		 prom_paper_rate promPaperRate,
		 promotion_rate promotionRate,
		 direct_agent_rate directAgentRate,
		 serve_rate serveRate,
		 subsidy_rate subsidyRate
		FROM
		  zx_agent  
		  WHERE 
		  del_flag = '0'
		  <if test="agentId != null and agentId != ''">
		    AND agent_id = #{agentId}
		  </if>
    </select>
    
    <!-- 加盟商（机主） -->
    <select id="selectzxjoinlist"  resultType="java.util.HashMap">
	    SELECT 
		 ad_rate adRate,
		 ad_carousel_rate adCarouselRate,
		 scan_rate  scanRate,
		 prom_direct_rate promDirectRate,
		 prom_indirect_rate  promIndirectRate,
		 prom_paper_rate promPaperRate,
		 promotion_rate promotionRate,
		 0.0 directAgentRate,
		 serve_rate serveRate,
		 0.0 subsidyRate
		FROM
		  zx_join 
		WHERE del_flag != '0' 
		<if test="joinId != null and joinId != ''">
		   AND join_id= #{joinId}
		</if>
		<if test="joinerId != null and joinerId != ''">
		    AND joiner_id = #{joinerId}
		</if>
    </select>
     <!-- 服务商 -->
     <select id="selectzxrepairlist"  resultType="java.util.HashMap">
	   SELECT 
		  ad_rate adRate,
		 ad_carousel_rate adCarouselRate,
		 scan_rate  scanRate,
		 prom_direct_rate promDirectRate,
		 prom_indirect_rate  promIndirectRate,
		 prom_paper_rate promPaperRate,
		 promotion_rate promotionRate,
		 0.0 directAgentRate,
		 0.0 serveRate,
		 subsidy_rate subsidyRate
		FROM
		  zx_repair 
		WHERE del_flag != '0' 
		<if test="repairId != null and repairId != ''">
		  AND repair_id= #{repairId} 
		</if>
    </select>
     <!-- 服务网点地区 -->
    <select id="selectzxrepairarealist"  resultType="java.util.HashMap">
	  SELECT 
		  * 
		FROM
		  zx_repair_area 
		WHERE  1=1
		<if test="repairId != null and repairId != ''">
		  AND repair_id= #{repairId} 
		</if>
		<if test="countyId != null and countyId != ''">
		  AND county_id= #{countyId} 
		</if>
    </select>
    
</mapper>