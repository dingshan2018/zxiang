<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head th:include="include :: header">
</head>
<body class="white-bg">

	<div class="wrapper wrapper-content animated fadeInRight ibox-content">
		<form class="form-horizontal m" id="form-adSchedule-materialUpload" th:object="${adSchedule}">
			<div class="form-group">	
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放名称：</label>
				<div class="col-sm-8">
					<input id="adScheduleId" name="adScheduleId" class="form-control" th:field="*{adScheduleId}" type="hidden">
					<input id="scheduleName" name="scheduleName" class="form-control" th:field="*{scheduleName}" type="text"readonly="readonly">
				</div>
			</div>
            <div class="form-group">	
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放位置：</label>
                <div class="col-sm-8">
	                <input id="releasePosition" name="releasePosition" th:field="*{releasePosition}"  type="hidden">
                    <input id="releasePositionName" name="releasePositionName" th:field="*{releasePositionName}" class="form-control" type="text" readonly="readonly">
                </div>
            </div>
            <div class="form-group">
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>模板元素：</label>
				<div class="col-sm-8">
					<label th:each="element:${elementList}" class="checkbox-inline i-checks">
						<input name="element" type="checkbox" th:value="${element.id}" th:text="${element.elementName}">
					</label>
				</div>
			</div>
            
			<br><br>
			<div id="fileUploadContent" class="fileUploadContent"></div>
			<span style="color: red;">*&nbsp;最多上传30个图片/视频文件;每个文件最大30M</span>
		  	<br><br>
		  	<button onclick="submitUpload()" class="btn btn-primary">上传</button>
		  	<!-- <button onclick="showUpError()" class="btn btn-primary">显示错误</button> -->
		</form>
	</div> 

  <div th:include="include::footer"></div>
  <link th:href="@{/css/iconfont.css}" rel="stylesheet"/>
  <link th:href="@{/css/fileUpload.css}" rel="stylesheet"/>
  <script th:src="@{/js/fileUpload.js}"></script>
  <script>
	  var prefix = ctx + 'advertise/adSchedule';
	  $('#form-adSchedule-materialUpload').validate({
	    rules        : {
	      fileUpload: {
	        required: true
	      },
	    },
	    messages     : {
	      'fileUpload': {
	        	required: '请选择上传文件'
	      }
	    },
	    submitHandler: function (form) {
	      //materialUploadSubmit();
	    }
	  });
  	
    $('#fileUploadContent').initUpload({
      'uploadUrl'       : ctx + 'advertise/adSchedule/materialUploadSave',//上传文件信息地址
      //'progressUrl'     : '#',//获取进度信息地址，可选，注意需要返回的data格式如下（{bytesRead: 102516060, contentLength: 102516060, items: 1, percent: 100, startTime: 1489223136317, useTime: 2767}）
      //'selfUploadBtId'  : 'selfUploadBt',//自定义文件上传按钮id
      'isHiddenUploadBt': false,//是否隐藏上传按钮
      'isHiddenCleanBt' : false,//是否隐藏清除按钮
      'isAutoClean'     : false,//是否上传完成后自动清除
      //'velocity'        : 10,//模拟进度上传数据
      //"showSummerProgress":false,//总进度条，默认限制
      //"scheduleStandard":true,//模拟进度的方式，设置为true是按总进度，用于控制上传时间，如果设置为false,按照文件数据的总量,默认为false
      "size":30720,//文件大小限制，单位kb,默认不限制
      "maxFileNumber":30,//文件个数限制，为整数
      //"filelSavePath":"",//文件上传地址，后台设置的根目录
      "beforeUpload":beforeUploadFun,//在上传前执行的函数
      "onUpload":onUploadFun,//在上传后执行的函数
      // autoCommit:true,//文件是否自动上传
      "fileType":['png','jpg','jpeg','gif','bmp','avi','rmvb',
                  'rm','asf','divx','mpg','mpg','mpeg','mpe','wmv','mp4','mkv','vob'],//文件类型限制，默认不限制，注意写的是文件后缀
    });

    function beforeUploadFun (opt) {
    	/* var elements = $.form.selectCheckeds("element");
    	if(elements.length <= 0){
       		alert("请先选择模板元素!");
			return;
       	} */
    	
    	opt.otherData = [
        	{
        		'name' : 'adScheduleId',
        		'value': $("#adScheduleId").val()
        	},
        	{
        		'name' : 'scheduleName',
        		'value': $("#scheduleName").val()
        	},
        	{
        		'name' : 'elementId',
        		'value': $.form.selectCheckeds("element")
        	}];
    }

    function onUploadFun (opt, data) {
      //alert(data);
      //uploadTools.uploadError(opt); //显示上传错误
     	$(".subberProgress").css("display","none");
    	alert(data.msg);
        $.modal.close();
        //刷新管理页面
        $.modal.reload();
    }

    function submitUpload () {
    	$.modal.confirm("确定上传？", function() {
	    	var opt = uploadTools.getOpt('fileUploadContent');
		    uploadEvent.uploadFileEvent(opt);
		});
    }

    function showUpError () {
      var opt = uploadTools.getOpt('fileUploadContent');
      uploadTools.uploadError(opt); //显示上传错误
    }

    //显示文件，设置删除事件
    // uploadTools.showFileResult('fileUploadContent', 'https://ps.ssl.qhmsg.com/t01e39e571b0b9b9867.jpg', '1', true, deleteFileByMySelf);

    //如果不需要删除
    // uploadTools.showFileResult('fileUploadContent', 'https://ps.ssl.qhmsg.com/t01e39e571b0b9b9867.jpg', '1', false);

    //多文件需要自己进行循环
    function deleteFileByMySelf (fileId) {
      alert('删除文件提醒：' + fileId);
    }
    
  	//提交请求
    function materialUploadSubmit () {
    	var formdata = new FormData();
    	formdata.append("adScheduleId", $("#adScheduleId").val());
		console.log("adScheduleId",$("#adScheduleId").val());
		
		for(var i=0;i<$("#fileUpload")[0].files.length;i++){
			formdata.append("fileUpload", $("#fileUpload")[0].files[i]);
		}
    	$.ajax({
    		url : prefix + "/materialUploadSave",
    		type:"post",  
    		contentType: false,  
            processData: false, 
            data: formdata,
    		async : false,
    		error : function(request) {
    			$.modal.alertError("系统错误");
    		},
    		success : function(data) {
    			if(data.code == 0){
    				alert(data.msg);
    				$.modal.close();
        			//刷新管理页面
        			$.modal.reload();
        			
    			}else{
    				alert(data.msg);
    			}
    		}
    	});
    }
  </script>
</body>
</html>
