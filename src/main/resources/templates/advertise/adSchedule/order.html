<!DOCTYPE HTML>
<html  lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-adSchedule-order" th:object="${adSchedule}">
			<div class="form-group">
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放名称：</label>
				<div class="col-sm-8">
					<input id="adScheduleId" name="adScheduleId" class="form-control" th:field="*{adScheduleId}" type="hidden">
					<input id="scheduleName" name="scheduleName" class="form-control" th:field="*{scheduleName}" type="text"readonly="readonly">
					<input id="pId" name="pId" class="form-control" th:field="*{pId}" type="hidden">
					<input id="tId" name="tId" class="form-control" th:field="*{tId}" type="hidden">
				</div>
			</div>
            <div class="form-group">
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放位置：</label>
                <div class="col-sm-8">
	                <input id="releasePosition" name="releasePosition" th:field="*{releasePosition}"  type="hidden">
                    <input id="releasePositionName" name="releasePositionName" th:field="*{releasePositionName}" class="form-control" type="text" readonly="readonly">
                </div>
            </div>
			<div class="form-group">
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放方式：</label>
				<div class="col-sm-8">
					<select id="releaseType" name="releaseType" class="form-control"
					onchange="showSelectTyte(this.options[this.options.selectedIndex].value)">
						<option value="">---请选择---</option>
						<option value="0">全部</option>
						<option value="1">按地区投放</option>
						<option value="2">按场所投放</option>
					</select>
				</div>
			</div>
			<div class="form-group" id="areaDiv" style="display: none;">
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>地区：</label>
				<div class="col-sm-8">
					<!-- <select id="areaGrade" name="areaGrade" class="form-control" th:with="type=${@dict.getType('area_grade')}">
						<option value="">---请选择---</option>
						<option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
					</select> -->
					<div class="select-list">
						<label >省份：</label>
						<select name="province" id="province" onchange="getDeviceByareaId(this.options[this.options.selectedIndex].value)">
	                       	<option value="">---请选择---</option>
	                    </select>
	                    <label >&nbsp;城市：</label>
						<select name="city" id="city" onchange="getDeviceByareaId(this.options[this.options.selectedIndex].value)">
	                        <option value="">---请选择---</option>
	                    </select>
	                    <label >&nbsp;区县：</label>
						<select name="county" id="county" onchange="getDeviceByareaId(this.options[this.options.selectedIndex].value)">
	                        <option value="">---请选择---</option>
	                    </select>
					</div>

				</div>
			</div>
			<div class="form-group" id="placeDiv" style="display: none;">
				<label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>场所：</label>
				<div class="col-sm-8">
					<select id="placeGrade" name="placeGrade" class="form-control"
					onchange="getDeviceByPlaceId(this.options[this.options.selectedIndex].value)">
						<option value="">---请选择---</option>
						<option th:each="place:${placeDropBoxList}" th:value="${place.placeId}" th:text="${place.name}"></option>
					</select>
				</div>
			</div>
			<div class="form-group">
        <label class="col-sm-3 control-label">投放时段：</label>
        <div class="col-sm-8 control-time-slot">
          <div class="col-sm-4" style="padding: 0;">
            <!-- id="startTime" -->
            <input type="text" class="time-input form-control date-time-picker" placeholder="开始时间" name="params[beginTime]" readonly/>
            <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
          </div>
          <div class="col-sm-1" style="padding: 0;line-height: 34px;text-align: center">
            <span>-</span>
          </div>
          <div class="col-sm-4" style="padding: 0;">
            <!-- id="endTime" -->
            <input type="text" class="time-input form-control date-time-picker" placeholder="结束时间" name="params[endTime]" readonly/>
            <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
          </div>
          <div class="col-sm-3 time-slot-btns" style="padding: 0 0 0 4px;">
            <button class="btn btn-primary btn-add-time-slot" type="button" onclick="addTimeSlot(this)">添加</button>
            <button class="btn btn-danger" type="button" onclick="deleteTimeSlot(this)">删除</button>
          </div>
        </div>
      </div>
			<div class="form-group">
				<label class="col-sm-3 control-label">投放设备：</label>
				<div class="col-sm-8">
					<label class="checkbox-inline i-checks" >
						<input name="checkAll" id="checkAll" type="checkbox">全选
					</label><br/>
					<div id="loadDeviceDiv"></div>
					 <!--<label th:each="device:${devices}" class="checkbox-inline i-checks">
						<input name="device" type="checkbox" th:value="${device.deviceId}" th:text="${device.deviceCode}" th:disabled="${device.delFlag == '1'}">
					</label>-->
				</div>
			</div>
			<div class="form-group">
				<div class="form-control-static col-sm-offset-9">
					<button type="submit" class="btn btn-primary">提交</button>
					<button onclick="$.modal.close()" class="btn btn-danger" type="button">关闭</button>
				</div>
			</div>
		</form>
	</div>
    <div th:include="include::footer"></div>
    <link th:href="@{/css/bootstrap-datetimepicker.min.css}" rel="stylesheet"/>
  <style>
    .time-error{
      position: absolute;
      right: 18px;
      top: 7px;
      color: #ef392b;
      font-size: 12px;
    }

  </style>
  <script th:src="@{/js/bootstrap-datetimepicker.min.js}"></script>
  <script th:src="@{/js/bootstrap-datetimepicker.zh-CN.js}"></script>
  <script type="text/javascript">
		var prefix = ctx + "advertise/adSchedule"
		$("#form-adSchedule-order").validate({
			rules:{
				scheduleName:{
					required:true,
				},
				releaseType:{
					required:true,
				},
			},
			submitHandler: function(form) {
			  var dateTimeValidate = true;
			  var timeSlotArr = [];
			  $('.date-time-picker').each(function () {
          if (!(!!$(this).val())){
            dateTimeValidate = false;
            $(this).addClass('error').siblings('.time-error').show();
          }else{
            $(this).removeClass('error').siblings('.time-error').hide();
          }
        });
			  if (!dateTimeValidate) return;
        $('.control-time-slot').each(function () {
          timeSlotArr.push({
            beginTime: $(this).find('.date-time-picker:first').val(),
            endTime: $(this).find('.date-time-picker:last').val(),
          })
        });
        orderSaveFun(timeSlotArr);
			}
		});

	    function orderSaveFun(timeSlotArr) {
        	var adScheduleId = $("#adScheduleId").val();
        	var scheduleName = $("#scheduleName").val();
        	var pId = $("#pId").val();
        	var tId = $("#tId").val();
        	var releaseType = $.form.selectSelects("releaseType");
        	var deviceIds = $.form.selectCheckeds("device");
        	if(deviceIds.length <= 0){
	       		alert("没有选择可投放的设备!");
				return;
	       	}
        	
        	$.ajax({
        		cache : true,
        		type : "POST",
        		url : prefix + "/orderSave",
        		data : {
        			"adScheduleId" : adScheduleId,
        			"scheduleName" : scheduleName,
        			"releaseType" : releaseType,
        			"deviceIds" : deviceIds,
        			"pId"	: pId,
        			"tId"	: tId,
              		"timeSlotArr": JSON.stringify(timeSlotArr)
        		},
        		async : false,
        		error : function(request) {
        			$.modal.alertError("系统错误");
        		},
        		success : function(data) {
        			$.operate.saveSuccess(data);
        		}
        	});
        }

		//投放方式onchange事件
		function showSelectTyte(value){
			//清空设备列表和全选选择
			$('#loadDeviceDiv').html('');
			$("#checkAll").iCheck("uncheck");
			
			$("#province").html("<option value=''>---请选择---</option>");
			$("#city").html("<option value=''>---请选择---</option>");
			$("#county").html("<option value=''>---请选择---</option>");
	        if(value=="0"){
	        	$("#areaDiv").hide();
	        	$("#placeDiv").hide();
	        	$("#areaGrade").val("");
	        	$("#placeGrade").val("");
	        	//投放方式选择全部的时候加载全部设备
	        	loadDevices(selectDeviceList());

	        } else if(value=="1"){
	        	proviceBind();
	        	$("#areaDiv").show();
	        	$("#placeDiv").hide();
	        	$("#areaGrade").val("");
	        	$("#placeGrade").val("");
	        } else if(value=="2"){
	        	$("#areaDiv").hide();
	        	$("#placeDiv").show();
	        	$("#areaGrade").val("");
	        	$("#placeGrade").val("");
	        }else{
	        	$("#areaDiv").hide();
	        	$("#placeDiv").hide();
	        	$("#areaGrade").val("");
	        	$("#placeGrade").val("");
	        }
	    }

		//选择场所加载设备事件
		function getDeviceByPlaceId(value){
			var deviceList = [];
			$.ajax({
		         url: ctx + "business/device/getDeviceByPlaceId",
		         type: "post",
		         contentType:"application/json",
		         dataType: "json",
		         data: JSON.stringify({ "placeId": value}),
		         async:false,
		         success: function (data) {
		        	 deviceList = data.rows;
		         },
		         error: function (data) {
		             alert("查询设备失败" + data);
		         }
		    })
		   	loadDevices(deviceList);
		}

		//选择地区加载设备事件
		function getDeviceByareaId(value){
			var deviceList = [];
			var province = $("#province").val();
			var city = $("#city").val();
			var county = $("#county").val();

			$.ajax({
		         url: ctx + "business/device/getDeviceByareaId",
		         type: "post",
		         contentType:"application/json",
		         dataType: "json",
		         data: JSON.stringify({ "province": province,"city": city,"county": county}),
		         async:false,
		         success: function (data) {
		        	 deviceList = data.rows;
		         },
		         error: function (data) {
		             alert("查询设备失败" + data);
		         }
		    })
		   	loadDevices(deviceList);
		}

		//渲染设备数据
		function loadDevices(deviceList){
      		var html          = '',
          	$checkAll     = $('#checkAll'),
          	$deviceChecks = undefined;
	
	      	// 取消全选状态
	      	$checkAll.iCheck('uncheck');
	
	      	for (var i = 0; i < deviceList.length; i++) {
	       	 html += `<label class="checkbox-inline i-checks">
	         	<input name="device" type="checkbox" value="${deviceList[i].deviceId}" >${deviceList[i].deviceCode}
	          	</label>`;
	      	}
	
	      	$('#loadDeviceDiv').html(html);
	
	      	$deviceChecks = $('#loadDeviceDiv input[name="device"]');
	
	      	// deviceChecks初始化
	     	 $deviceChecks.iCheck({
	        	checkboxClass : 'icheckbox_square-green',
	        	radioClass: "iradio_square-green"
	      	});
	
	      	// deviceChecks事件改变全选checkAll状态.
	      	$deviceChecks.on('ifChanged', function(event){
		        if($deviceChecks.filter(':checked').length === $deviceChecks.length) {
		          $checkAll.prop('checked', true);
		        } else {
		          $checkAll.prop('checked', false);
		        }
		        $checkAll.iCheck('update');
	      	});
	
    	}
	
		function proviceBind() {
	        //清空下拉数据
	        $("#province").html("");
	        var str = "<option value=''>---请选择---</option>";

	        var provinceAreaList = selectAreaListByPid("0");
	        $.each(provinceAreaList, function (i, item) {
                str += "<option value=" + item.id + ">" + item.pname + "</option>";
            })
            //将数据添加到省份这个下拉框里面
            $("#province").append(str);
	    }
	    function cityBind() {
	        var provice = $("#province option:selected").val();
	        //判断省份这个下拉框选中的值是否为空
	        if (provice == "") {
	            return;
	        }
	        $("#city").html("");
	        $("#county").html("<option value=''>---请选择---</option>");
	        var str = "<option value=''>---请选择---</option>";

	        var cityAreaList = selectAreaListByPid(provice);
	        $.each(cityAreaList, function (i, item) {
                str += "<option value=" + item.id + ">" + item.pname + "</option>";
            })
            //将数据添加到市这个下拉框里面
            $("#city").append(str);
	    }
	    function countyBind() {
	        var provice = $("#city option:selected").val();
	        //判断市这个下拉框选中的值是否为空
	        if (provice == "") {
	            return;
	        }
	        $("#county").html("");
	        var str = "<option value=''>---请选择---</option>";

	        var countyAreaList = selectAreaListByPid(provice);
	        $.each(countyAreaList, function (i, item) {
                str += "<option value=" + item.id + ">" + item.pname + "</option>";
            })
            //将数据添加到区县这个下拉框里面
            $("#county").append(str);
	    }
	
	    $(function () {
	      // 设备全选或不选.
	      $('#checkAll').on('ifChecked ifUnchecked', function(event) {
	        var deviceChecks = $('#loadDeviceDiv input[name="device"]');
	        if (event.type === 'ifChecked') {
	          deviceChecks.iCheck('check');
	        } else {
	          deviceChecks.iCheck('uncheck');
	        }
	      });
	
	      //默认绑定省
	      proviceBind();
	      //绑定事件
	      $('#province').change(function () {
	        cityBind();
	      });
	
	      $('#city').change(function () {
	        countyBind();
	      });
	    });
	
	    // 日期选择器初始化
	    function initDateTimePicker (select) {
	      $(select || '.date-time-picker').datetimepicker({
	        language:  'zh-CN',
	        format: 'hh:ii:ss',
	        todayBtn:  1,
	        autoclose: true,
	        todayHighlight: 1,
	        startView: 0,
	        showMeridian: 1,
	        minuteStep: 1
	      }).on('changeDate', function(ev){
	        $(ev.target).parents('.control-time-slot').find('.date-time-picker:last').eq(0).datetimepicker('setStartDate', ev.date);
	      });
	    }
	    initDateTimePicker();
	
	    var addTimeSlotTemplate = `<div class="col-sm-8 control-time-slot col-sm-offset-3" style="margin-top: 15px;display: none;">
	        <div class="col-sm-4" style="padding: 0;">
	        <input type="text" class="time-input form-control date-time-picker" placeholder="开始时间" name="params[beginTime]" readonly/>
	        <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
	      </div>
	      <div class="col-sm-1" style="padding: 0;line-height: 34px;text-align: center">
	        <span>-</span>
	        </div>
	        <div class="col-sm-4" style="padding: 0;">
	        <input type="text" class="time-input form-control date-time-picker" placeholder="结束时间" name="params[endTime]" readonly/>
	        <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
	      </div>
	      <div class="col-sm-3 time-slot-btns" style="padding: 0 4px;">
	        <button class="btn btn-primary btn-add-time-slot" type="button" onclick="addTimeSlot(this)">添加</button>
	        <button class="btn btn-danger" type="button" onclick="deleteTimeSlot(this)">删除</button>
	        </div>
	        </div>`;
	
	    // 添加时间段
	    function addTimeSlot (_this) {
	      $(_this).parents('.form-group').append(addTimeSlotTemplate);
	      $(_this).remove();
	      initDateTimePicker('.control-time-slot:last .date-time-picker');
	      $('.control-time-slot:last').css('display', 'block');
	    }
	
	    var removeTimeSlotTemplate = `<div class="col-sm-8 control-time-slot">
	        <div class="col-sm-4" style="padding: 0;">
	        <input type="text" class="time-input form-control date-time-picker" placeholder="开始时间" name="params[beginTime]" readonly/>
	        <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
	      </div>
	      <div class="col-sm-1" style="padding: 0;line-height: 34px;text-align: center">
	        <span>-</span>
	        </div>
	        <div class="col-sm-4" style="padding: 0;">
	        <input type="text" class="time-input form-control date-time-picker" placeholder="结束时间" name="params[endTime]" readonly/>
	        <label class="time-error" style="display: none;"><i class="fa fa-times-circle"></i>  必填</label>
	      </div>
	      <div class="col-sm-3 time-slot-btns" style="padding: 0 4px;">
	        <button class="btn btn-primary btn-add-time-slot" type="button" onclick="addTimeSlot(this)">添加</button>
	        <button class="btn btn-danger" type="button" onclick="deleteTimeSlot(this)">删除</button>
	        </div>
	      </div>`;
	    var timeSlotBtnAdd = `<button class="btn btn-primary btn-add-time-slot" type="button" onclick="addTimeSlot(this)">添加</button>`;
	
	    // 删除时间段
	    function deleteTimeSlot (_this) {
	      var formGroup = $(_this).parents('.form-group');
	      $(_this).parents('.control-time-slot').remove();
	      if ($('.control-time-slot').length <= 0) {
	        formGroup.append(removeTimeSlotTemplate);
	        initDateTimePicker('.control-time-slot:first .date-time-picker')
	      }
	      if ($('.btn-add-time-slot').length <= 0){
	        $('.time-slot-btns:last').prepend(timeSlotBtnAdd);
	      }
	      $('.control-time-slot:first').removeClass('col-sm-offset-3').css('margin-top', '0');
	    }

	</script>
</body>
</html>
