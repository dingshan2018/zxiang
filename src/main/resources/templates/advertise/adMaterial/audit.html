<!DOCTYPE HTML>
<html  lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head th:include="include :: header">
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-adSchedule-audit" th:object="${adMaterial}">
            <div class="form-group">	
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>投放名称：</label>
                <div class="col-sm-8">
                	<input id="adMaterialId" name="adMaterialId" th:field="*{adMaterialId}"  type="hidden">
                	<input id="preview" name="preview" th:field="*{preview}"  type="hidden">
                	<input id="remark" name="remark" th:field="*{remark}"  type="hidden">
                	<input id="materialText" name="materialText" th:field="*{materialText}"  type="hidden">
                    <input id="fileName" name="fileName" th:field="*{fileName}" class="form-control" type="text" readonly="readonly">
                </div>
            </div>

            <div class="form-group">	
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>预览素材：</label>
                <div class="col-sm-8">
                	 <div class="image-list" id="image-list"></div>
                </div>
            </div>            
            <div class="form-group">	
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>审核结果：</label>
                <div class="col-sm-8">
                	<input type="radio" name="status" value="2" class="radio-box">通过
					<input type="radio" name="status" value="1" class="radio-box">不通过
                </div>
            </div>
            <div class="form-group">	
                <label class="col-sm-3 control-label"><span style="color: red;">*&nbsp;</span>审核意见：</label>
                <div class="col-sm-8">
                	<textarea id="auditOpinion" name="auditOpinion" class="form-control" placeholder="请输入审核意见"></textarea>
                </div>
            </div>
            
			<div class="form-group">
				<div class="form-control-static col-sm-offset-9">
					<button type="submit" class="btn btn-primary">提交</button>
					<button onclick="$.modal.close()" class="btn btn-danger" type="button">关闭</button>
				</div>
			</div>
		</form>
    </div>
    <div th:include="include::footer"></div>
    <script th:src="@{/js/jquery.mousewheel.min.js}"></script>
    <script th:src="@{/js/pictureViewer.js}"></script>
    <script type="text/javascript">
		var prefix = ctx + "advertise/adMaterial"
		$("#form-adSchedule-audit").validate({
			rules:{
				filename:{
					required:true,
				},
				status:{
					required:true,
				},
				auditOpinion:{
					required:true,
				},
			},
			submitHandler: function(form) {
				var filename = $("#fileName").val();
				var aduitResult = $("input[name='status']:checked").val()=="2"?'通过':'不通过';
				$.modal.confirm("确定对素材 "+ filename + " 审核 " + aduitResult + " ?", function() {
					$.operate.save(prefix + "/auditSave", $('#form-adSchedule-audit').serialize());
		    	});
			}
		});
		
		$(function () {
	  		//TODO 加载素材列表
			getPreviewUrl();
			
	        $('.image-list').on('click', '.cover', function () {
	            var this_ = $(this);
	            var images = this_.parents('.image-list').find('.cover');
	            var imagesArr = new Array();
	            $.each(images, function (i, image) {
	                imagesArr.push($(image).children('img').attr('src'));
	            });
	            $.pictureViewer({
	                images: imagesArr, //需要查看的图片，数据类型为数组
	                initImageIndex: this_.index() + 1, //初始查看第几张图片，默认1
	                scrollSwitch: true //是否使用鼠标滚轮切换图片，默认false
	            });
	        });
	    });
		
		//预览函数
		function preview(){
			var adScheduleId = $("#adScheduleId").val();
			//var url = ctx + "advertise/adSchedule/preview/" + adScheduleId;
	    	//$.modal.openFull("素材预览", url);
		}
		
		//获取预览文件
		function getPreviewUrl(){
			debugger;
			var previewUrls = [];
			var preview = $('#preview').val();
			var remark = $('#remark').val();
			if(preview != '' && preview != null){
				if(remark === '图片'){
					previewUrls.push(preview);
					var html = '';
					if(previewUrls.length > 0){
						for (var i = 0; i < previewUrls.length; i++) {
				       	 	html += `<div class="cover"><img src="${previewUrls[i]}" style="width: 100%;" alt=""></div>`;
				      	}
				      	$('#image-list').html(html);
					}else{
						$('#image-list').html("<h4 align=\"center\">暂无素材信息!</h4>");
					}
				}else if(remark === '视频'){
					var html = `<video id="video"  style="width: 100%;" src="${preview}" preload="auto" controls="controls" autoplay="autoplay"></video>`
					$('#image-list').html(html);
				}
				
			}else if(remark === '文本'){
				var materialText = $('#materialText').val();
				$('#image-list').html("<h4 align=\"center\">"+materialText+"</h4>");
			}
			
			
		}
		
		function adView(){
			var http = "http://mmedia.bp.zcloudtechs.cn/mmedia/pageJump/go_programme_view.action?scheduleId=";
			var sxScheduleId = $("#sxScheduleId").val();
			//console.log("http + sxScheduleId:",http + sxScheduleId);
			if(sxScheduleId != '' && sxScheduleId != null){
				var url = http + sxScheduleId;
				window.open(url);
		    	//$.modal.openFull("素材预览", url);
			}else{
				//$.modal.alertWarning("暂未生成排期广告!");
				var url = ctx + "advertise/adSchedule/preview/" + adScheduleId;
		    	$.modal.openFull("素材预览", url);
			}
			
		}
	</script>
</body>
</html>
