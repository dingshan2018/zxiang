<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<body class="gray-bg">
  <div class="container-div">
    <div class="col-sm-12 select-info">
      <form id="terminal-form">
        <div class="select-list">
          <ul>
            <li>
              <span class="select-item-name">资产编号：</span>
              <input type="text" name="deviceSn" id="deviceSn"/>
            </li>
           <!--  <li class="select-cascade">
              <span class="select-item-name">省：</span>
              <select name="province" id="province">
                <option value="">全部</option>
              </select>
              <span class="select-item-name">市：</span>
              <select name="city" id="city">
                <option value="">全部</option>
              </select>
              <span class="select-item-name">区县：</span>
              <select name="county" id="county">
                <option value="">全部</option>
              </select>
            </li> -->
            <li class="select-btns">
              <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索
              </a>
              <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i class="fa fa-refresh"></i>&nbsp;重置
              </a>
              <a class="btn btn-primary btn-rounded btn-sm" onclick="outStockByTradeId()" shiro:hasPermission="business:deviceStock:outStock">
                <i class="fa fa-edit"></i>&nbsp;出库
              </a>
            </li>
          </ul>
        </div>
      </form>
    </div>

    <div class="btn-group hidden-xs" id="toolbar" role="group">
      <a class="btn btn-outline btn-success btn-rounded" onclick="$.operate.add()" shiro:hasPermission="business:device:add">
        <i class="fa fa-plus"></i> 新增
      </a>
      <a class="btn btn-outline btn-danger btn-rounded" onclick="$.operate.removeAll()" shiro:hasPermission="business:device:remove">
        <i class="fa fa-trash-o"></i> 删除
      </a>
      <a class="btn btn-outline btn-success btn-rounded" onclick="batchImport()" shiro:hasPermission="business:device:add">
        <i class="fa fa-plus"></i> 批量导入
      </a>
    </div>

    <div class="col-sm-12 select-table table-striped">
      <table id="bootstrap-table" data-mobile-responsive="true"></table>
    </div>
  </div>
  <div th:include="include :: footer"></div>
  <script th:inline="javascript">
    var editFlag = [[${@permission.hasPermi('business:device:edit')}]];
    var removeFlag = [[${@permission.hasPermi('business:device:remove')}]];
    var prefix = ctx + 'business/deviceStock';

    $(function () {

      /* //投放地区联动搜索
      //默认绑定省
      proviceBind();
      //绑定事件
      $('#province').change(function () {
        cityBind();
      });

      $('#city').change(function () {
        countyBind();
      }); */

      var options = {
        url       : prefix + '/list',
        createUrl : prefix + '/add',
        updateUrl : prefix + '/edit/{id}',
        removeUrl : prefix + '/remove',
        modalName : '共享设备',
        search    : false,
        showExport: false,
        columns   : [
          {
            checkbox: true
          },
          {
            field: 'deviceId',
            title: '设备ID'
          },
          {
            field: 'deviceCode',
            title: '设备编号'
          },
          {
              field: 'deviceSn',
              title: '资产编号'
          },
          {
            field: 'placeName',
            title: '场所'
          },
          {
            field: 'terminalCode',
            title: '终端编号'
          },
          {
              field: 'deviceType',
              title: '设备类型'
          },
          {
              field: 'ownerName',
              title: '机主'
          },
          {
            field: 'releaseTime',
            title: '投放时间'
          },
          {
            field: 'removeTime',
            title: '撤机时间'
          },
          {
            field: 'lastHeartTime',
            title: '最后心跳时间'
          },
          {
            field: 'remainLen',
            title: '剩余出纸'
          },

          {
            field: 'lastScanTime',
            title: '最后扫码时间'
          },
          {
            field: 'note',
            title: '备注'
          },
          {
              field: 'status',
              title: '状态',
          },
          {
            field: 'statusName',
            title: '设备状态',
          },
          {
            field: 'createBy',
            title: '创建者'
          },
          {
            field: 'createTime',
            title: '创建时间'
          },
          {
            field: 'updateBy',
            title: '修改者'
          },
          {
            field: 'updateTime',
            title: '修改时间'
          },
          {
            title    : '操作',
            align    : 'center',
            formatter: function (value, row, index) {
              var actions = [];
             /*  actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="#" onclick="$.operate.edit(\'' +
                row.deviceId + '\')"><i class="fa fa-edit"></i>编辑</a> '); */
              actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="#" onclick="$.operate.remove(\'' +
                row.deviceId + '\')"><i class="fa fa-remove"></i>删除</a>');
              return actions.join('');
            }
          }]
      };
      $.table.init(options);
      $('#bootstrap-table').bootstrapTable('hideColumn', 'deviceId');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'placeName');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'lon');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'lat');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'delFlag');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'createBy');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'createTime');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'updateBy');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'updateTime');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'status');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'ownerName');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'releaseTime');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'removeTime');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'lastHeartTime');
      $('#bootstrap-table').bootstrapTable('hideColumn', 'remainLen');
    });

    function proviceBind () {
      //清空下拉数据
      $('#province').html('');
      var str = '<option value="">全部</option>';

      var provinceAreaList = selectAreaListByPid('0');
      $.each(provinceAreaList, function (i, item) {
        str += '<option value=' + item.id + '>' + item.pname + '</option>';
      });
      //将数据添加到省份这个下拉框里面
      $('#province').append(str);
    }

    function cityBind () {
      var provice = $('#province option:selected').val();
      //判断省份这个下拉框选中的值是否为空
      if (provice == '') {
        return;
      }
      $('#city').html('');
      var str = '<option value="">全部</option>';

      var cityAreaList = selectAreaListByPid(provice);
      $.each(cityAreaList, function (i, item) {
        str += '<option value=' + item.id + '>' + item.pname + '</option>';
      });
      //将数据添加到市这个下拉框里面
      $('#city').append(str);
    }

    function countyBind () {
      var provice = $('#city option:selected').val();
      //判断市这个下拉框选中的值是否为空
      if (provice == '') {
        return;
      }
      $('#county').html('');
      var str = '<option value="">全部</option>';

      var countyAreaList = selectAreaListByPid(provice);
      $.each(countyAreaList, function (i, item) {
        str += '<option value=' + item.id + '>' + item.pname + '</option>';
      });
      //将数据添加到区县这个下拉框里面
      $('#county').append(str);
    }

  	//批量导入设备资产编号弹窗函数
    function batchImport () {
      var url = ctx + 'business/device/batchImport';
      $.modal.open('批量导入设备资产编号', url);
    }
  
    //打开设备出库弹窗
    function outStock() {
      var rows = $.common.isEmpty($.table._option.id) ? $.table.selectFirstColumns() : $.table.selectColumns(
        $.table._option.id);
      if (rows.length == 0) {
        $.modal.alertWarning('请至少一条记录');
        return;
      }
      
      $.modal.confirm("确认要出库选中的 " + rows.length + " 条数据吗?", function() {
      	$.ajax({
      		cache : true,
      		type : "POST",
      		url : prefix + "/outStock",
      		data : {
      				"ids": rows.join()
      		},
      		async : false,
      		error : function(request) {
      			$.modal.alertError("系统错误");
      		},
      		success : function(data) {
      			$.modal.alert(data.msg);
      			$.table.search();
      		}
      	});
  	});
    }

  	//打开设备出库弹窗--选择订单后选择出库设备
    function outStockByTradeId() {
    	 var url = prefix + '/outStockByTradeId';
         $.modal.open('设备出库', url);
    }
  </script>
</body>
</html>